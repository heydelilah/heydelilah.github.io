---
layout: post
title:  "前端单元测试"
date:   2014-08-04 21:54:00
categories: Note
---

近期被安排去调研前端Unit testing情况。从一无所知到有了个大致了解，自我总结一下。

经过一系列比较，选择了`Mocha`测试框架，`chai`和`sinon`作为附加库；

前端单元测试可分浏览器端和服务端。部署是比较简单的，浏览器端基本上就是一个html引入各种所需测试框架文件与测试用例，然后mocha.run即可；服务端也是全局`npm install mocha`后，直接与bash端执行mocha命令即可。

不过一开始由于我并没有意识到有Browser和Server之分，而使用server那一套的部署方式捣鼓了很久，绕了很多圈子。Server端是没有document,windows等BOM对象的，所以根本是无法直接跑（后来发现了`jsdom`等，可在服务端模拟DOM，不过这是后话了），这是报错的原因，而我一直认为纠结于如何把浏览器端的seajs改为node端的seajs上。

Unit testing是好东西，它能解决我们此刻面临的重大问题：开发效率。这半年来，深刻体会到平日工作内容最多最烦心的不是逻辑开发，而是debug.需求每天都在新增，项目在臃肿，经手的程序员也越来越多；一处无关痛痒的改动，往往会牵动另一处的代码，于是就陷入了无穷无尽的debug深渊中。
当然，添加Unit test不是绝对的解决之法，最大限度的减少不必要的bug要各方面都一起加强：比如项目规范，逻辑开发时候考虑扩展性等等。

#### 如何写测试用例？

当明确了要添加Unit test后，就剩下测试用例要怎么写的问题了。理论上说这应该不是一个问题，但事实上这是最大的问题。

1. 测交互；-各种操作的组合情况 -需要模拟每种情况，而组合很多
2. 测DOM；-界面构建是否到达预期；-使用jq获取界面已创建好的元素，一一对比，十分繁琐；
3. 测数据；-相对好测一点。

所以如果真的使用TDD（测试驱动）的模式去开发，虽然维护效率会大大提升，但开发时间恐怕会增加一倍以上呢。
择取一些重点部分写测试用例吧，继续研究~

如果真的能以TDD的方式去开发就真挺好的，因为现项目面临的问题之一是耦合太重的问题。而写测试用例的过程是强迫自己解耦模块的过程，因为太耦合的代码写起测试用例来只会吐血。

#### TODO

1. 自动化测试，看看是不是能与`grunt`结合起来；
2. 调研一下无头测试- `phantomjs` ；
3. 添加代码覆盖率报告；使用`mockJS`模拟测试数据。

---------------------------------------


### 调研- 同类JS单元测试框架

### 一，测试框架

#### Qunit
- jquery团队, John Resig开发；简单美观，容易上手；
- 不能自动化浏览器测试

#### Jasmine
- BDD；基于Ruby.
- 和JsUnit( 已没更新）是同一群人写的;
- 大小：20K左右
- 使用： 淘宝UED
- 插件：jasmine-jQuery
- 对于Ruby语言有特别的支持

#### Mocha
- TJ大神。基于nodeJS
- 自由和geek；TDD,BDD可选；在bash端有特别亮点，如diff之类
- Chai  -BDD/TDD断言库

#### Sinon
- 由《Test-Driven JavaScript Development》一书的作者Christian Johansen开发。
- 为Javascript提供独立的spies，stubs和mocks。
- 更多的是作为一个辅助的测试工具集，可以跟Jasmine、Mocha、QUnit等任意测试框架结合使用


### 二，测试工具

不是JS测试框架，而是一个测试框架的驱动器（测试执行过程管理工具）测试所有主流 Web 浏览器， 自动化完成单元测试

#### JSTestDriver（不更新）
- 来自Google，基于JAVA编写。TDD。
- 安装使用稍微有点麻烦，依赖于JAVA环境。
- "通过使用功能强大的 JSTestDriver (JSTD) 工具，您能够在多个浏览器中从命令行运行 JavaScript。JSTD 带有一个 JAR 文件，它可以让您启动服务器、捕获一或多个浏览器并在这些浏览器中运行测试。"

#### Karma(Testacular)
- 来自 Google AngularJs团队，基于nodeJS，使用了socketio。类似JSTD
- 支持自动化测试；支持多个Javascript测试框架；支持同时多浏览器，多终端测试
- 支持PhantomJS无界面浏览器
- 不支持nodejs测试
- 不支持历史结果查询
- webstorm对它有特别支持

#### busterjs
- 作者之一就是Christian Johansen； 基于nodeJS；
- 支持自动化测试；支持多个Javascript测试框架；支持同时多浏览器，多终端测试
- 内建SinonJS
- 支持nodejs测试
- 可以在普通浏览器或无界面浏览器PhantomJS(soon)中运行
- 不支持历史结果查询
- 挺受瞩目的，但目前仍是beta版本，即可能会有bug。

#### Testem
- 基于nodejs,使用express和socketio; 2012年6月发布
- 大概和karma差不多吧，没仔细看。Jeffrey Way和Stephen Thomas都推荐过它。

#### TestSwarm
- John Resig创建的分布式Javascript测试工具；
- 开源；所有测试环境由服务器提供
- 支持历史结果查询

#### YUI Yeti
- Yahoo团队，基于nodejs
- 支持多种浏览器；可通过命令行运行。

### 三，CI

持续集成就是通常所谓的CI(Continuous integration)，持续不断的自动化测试新加入代码后的项目。它并不属于单元测试，而是另外的范畴，不过通过使用CI服务可以很容易的在Github上测试项目，而这也就是持续集成的意义。

- Jenkins
- Travis-CI
