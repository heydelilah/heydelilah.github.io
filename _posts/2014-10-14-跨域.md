---
layout: post
title:  "跨域"
date:   2014-10-14 23:37:00
categories: Note
---

跨域操作的一次尝试
=========================

## 描述

在页面A中，填写A页面的表单(dataA)，然后继续在A页面中去访问非同源的B页面，填写完B页面的表单(dataB)后，跳回A页面保存全部数据。

## 设计

![通讯方式](http://heydelilah.github.io/data/cross/desc.png)

通讯方式：
	- 客户端与客户端：`<iframe/>`内嵌窗体
	- 客户端与服务器：websocket/ajax/http
	- 服务器与服务器：tcp

## 流程

#### 1. 填写A页面的表单

![第1步](http://heydelilah.github.io/data/cross/1.png)

- 填写A页面的表单；
- 生成一个全局回调函数，名字为`cb_name`;
- A与B进行服务端对服务端的TCP通信：A用事先与B协议好的token，向B请求连接。
- （把data,`cb_name`以及回跳地址`cb_url`都以参数形式发给B，B先缓存这些数据）

#### 2. 在A页面中访问B页面，填写B页面表单

![第2步](http://heydelilah.github.io/data/cross/2.png)

- B通过验证后，返回给A登录验证码(token)和B的前端访问地址(url)；
- A在前端页面嵌入src为此url的子窗体，打开了B页面；（使用token通过B服务端的登录验证）
- 用户在B页面填写表单

#### 3. 返回A页面，保存全部数据

![第3步](http://heydelilah.github.io/data/cross/3.png)

- B的服务端接收由前端传来的表单数据，返回在第一步缓存的`cb_url`和`cb_name`，以及token；
- B前端重定向回A前端页面；`window.location.href = [cb_url]` (此时`cb_url`直接附带上`cb_name`和token信息返回)
- 回跳地址是一个静态页面，没有业务逻辑，只是负责处理回跳：
	1. 解析url,拿出searh里的token等信息 以及回调函数名`cb_name`
	2. window.top 因为此时在在window的iframe下，所以在拿最高处的window对象;
	3. 调用全局随机命名闭包函数。
	4. 最后删除引用，释放空间
- A服务器使用token，验证前端传来的数据是否被篡改过，没问题就保存信息到数据库；



## 跨域技术总结

** 在遵循浏览器同源策略下的跨域操作: **
1. 图片ping
	- 只能发请求，不能对返回的数据做操作。
	- 应用场景：广告统计
2. jsonp
	- 可发请求，也可获取返回的数据。只能获取一些从对方服务器返回的数据。
	- 应用场景：单点登录
3. iframe
	- 与jsonp原理一样，但它可以打开对方网页，让用户在对方网页做操作。交互更加丰富。
	- 应用场景：同时需要用户在本地网站与非同源网站填写信息。


** Access-Control-Allow-Origin **

真正的直接支持跨域，而不是'达到跨域效果的跨域技术'；要考虑安全性问题。

## ajax与302

为什么ajax 302跳不行? -没完全理解清楚

"You can't handle redirects with XHR callbacks because the browser takes care of them automatically. You will only get back what at the redirected location."