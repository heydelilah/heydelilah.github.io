---
layout: post
title:  "关于BiddingX 项目的一些思考"
date:   2015-04-23 10:01:00
categories: Note
tag: "总结" 
desc: "BiddingX项目是我工作这两年来一直在开发和维护的主要项目，在此自我整理一下工作时的心得体会。"
imgUrl: "data/post_thumb/biddingx.png"
---
![sunteng](/data/post_imgs/biddingx-logo.png)

![sunteng](/data/post_imgs/biddingx-grid.png)

<p style=" font-size:10px; text-align:center">图片来自 <a href="http://www.biddingx.com"><i>BiddingX 官网</i></a></p>

# BiddingX 是什么？

BiddingX 是互联网广告 DSP 平台，为广告商提供广告投放解决方案。通过大数据分析，实现广告精准投放。B2B级的产品。


# 前端用到哪些技术?

属于大型web app, SPA ，繁多的操作，复杂的交互。

#### 1. Pubjs框架：

- 使用 Seajs 做加载依赖，模块化开发；
- 类式继承；
- SPA 单页面应用, hash 路由，Javascript 动态构建；
- 消息机制，分为冒泡、广播以及模块对模块通信；
- 与服务端通信基本上使用 Ajax, 后期加入了 Websocket 做消息主动推送；	
- 封装 Jquery 以及自定义的工具库，方便 DOM 操作；
- 封装 AvalonJs 框架，使用 html 模版，数据双工绑定

#### 2. 样式：

由于公司的设计部门向来话语权微弱，于是在视觉设计方面几乎是前端工程师“为所欲为”的局面。视觉规范直接使用了一个轻量级的开源界面包 [uikit](http://getuikit.com/)，图标采用 [Font-Awsome](http://fortawesome.github.io/Font-Awesome/)。 设计部门和前端部门的合作，基本上只在交互设计的层面。

使用 LESS 编写 css， Grunt做 LESS 编译. css 命名规范遵循 BEM 思想，模块、组件、业务区别开来。

#### 3. 兼容性：

由于 BiddingX 是 B2B 级的产品，且面对的使用者都是得经过培训，所以对浏览器兼容性方面没太花精力去做，虽开发中会注意兼容性问题，但是没有全面测试。对于用户，通通都推荐他们使用 Chrome。

#### 4. 工具：

- 使用 Grunt 做 LESS 编译，Jshint 代码检查，自动化生成css雪碧图，代码压缩
- 使用 Git 做版本控制

# Biddingx 存在哪些问题？

- 项目庞大，存在大量多余的功能，亟待清理；
- 模块混乱，耦合严重，难以进行单元测试；
- 由于采用了js动态构建页面的方案，对dom的操作过于频繁，引发了大量的重绘重排；更重要的是html与js交融在一起，使得debug难度增大；
- 与后端部门的冲突。由于历史原因，一些数据结构的规范模棱两可，导致前端做了很多数据转换的无谓工作；

# 重构是怎么进行的?

第一步是与产品部门一起从头理清项目需求，取其精华，去其糟粕，大量删减老旧功能。

借鉴 Angular 框架的数据双工绑定功能。经过调研后，决定把国内司徒正美的一个改良版的轻量级框架 AvalonJs ，引入我们自己的 Pubjs 前端框架中。这是一个让我们开发上大改变的举动，因为在此之前，我们的开发流程基本上是，调用组件构建页面，小的地方直接 js 操作 DOM 元素去完成。而引入了 AvalonJs 后，真正实现了 html 与 js 逻辑代码分离，无论是开发、还是后期维护的效率都大大提高。

调研前端单元测试，本来计划从组件开始，把全部基本组件都补齐用例。不过由于时间关系，一直被delay了。于是只是搭建了个单元测试的环境，使用 Mocha 写断言，Grunt 自动运行用例。但用例基本上处于空状态。

最后说一说后端部分

Biddingx 项目的后端分为三级，最表层是应用层，由 PHP 所写，主要内容就是增删改查、搜索过滤等业务性的功能。而底层支持是 Golang 所写，支撑整个实时竞价平台，高并发，毫秒级响应。最后一部分是算法部门的工作，处理的就是关于数据挖掘之类的工作，广告投放是否精准，就要靠他们来提供方案了。

在 Biddingx 前端重构时，由于后端部门并不愿意改动旧的数据结构，“一气之下”，前端老大把原来由后端部门负责的业务应用层揽了过来，按照前端组优化过的新数据结构规范，使用 Nodejs 代替 PHP ，重写了整个业务层。

那一段时间虽然每天加班，但是时时刻刻都处于“全栈工程师”的兴奋之中。然而想象总是特别美好的，由于旧业务层庞大，前端组有心无力，连续加班3个月，疲倦不堪之中只是勉强出了个 bugs 超多的版本。


# 反思重构不顺利的原因是什么？

- 时间问题。简单的说，就是老板要求尽快上线的紧急程度超过了前端组的最初估计；
- 沟通问题。和后端部门没有达成共识，以至于后来的合作上出现的种种冲突让双方都感到郁闷；
- 技术问题。想把牛逼的新技术新东西都塞进去，前端老大是没问题，但是仅凭一人之力是搭不起万里长城。而组员既要赶工现有进度的同时，也要把之前没啥经验的新东西塞进去，出bug率增高。
